#!/usr/bin/env bash
set -euo pipefail

INTERNAL_MONITOR="eDP-1"
DEBOUNCE_SECS=1
debounce_pid=

apply_monitors() {
  local monitors external batch=""
  monitors=$(hyprctl monitors -j)
  external=$(echo "$monitors" | jq -r '.[].name' | grep -v "$INTERNAL_MONITOR" || true)

  if [[ -n "$external" ]]; then
    batch="keyword monitor $INTERNAL_MONITOR, disable"
    while read -r mon; do
      batch="$batch ; keyword monitor $mon, preferred, auto, 1.5"
    done <<< "$external"
  else
    batch="keyword monitor $INTERNAL_MONITOR, preferred, auto, 1.5"
  fi

  hyprctl --batch "$batch"
}

schedule_apply() {
  if [[ -n "$debounce_pid" ]] && kill -0 "$debounce_pid" 2>/dev/null; then
    kill "$debounce_pid" 2>/dev/null || true
  fi
  (sleep "$DEBOUNCE_SECS" && apply_monitors) &
  debounce_pid=$!
}

cleanup() {
  if [[ -n "$debounce_pid" ]] && kill -0 "$debounce_pid" 2>/dev/null; then
    kill "$debounce_pid" 2>/dev/null || true
  fi
  exit 0
}
trap cleanup EXIT INT TERM

apply_monitors

SOCKET="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"
while true; do
  socat -u "UNIX-CONNECT:$SOCKET" - | while IFS= read -r line; do
    case "$line" in
      monitoradded\>*|monitorremoved\>*|configreloaded\>*)
        schedule_apply
        ;;
    esac
  done || true
  sleep 1
  apply_monitors
done
