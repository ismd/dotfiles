#!/usr/bin/env bash
set -euo pipefail

INTERNAL_MONITOR="eDP-1"
MONITORS_CONF="$HOME/.config/hypr/monitors.conf"
DEBOUNCE_SECS=1
debounce_pid=

apply_monitors() {
  local monitors external conf=""
  monitors=$(hyprctl monitors -j)
  external=$(echo "$monitors" | jq -r '.[].name' | grep -v "$INTERNAL_MONITOR" || true)

  if [[ -n "$external" ]]; then
    conf="monitor = $INTERNAL_MONITOR, disable"
    while read -r mon; do
      conf="$conf"$'\n'"monitor = $mon, preferred, auto, 1.5"
    done <<< "$external"
  else
    conf="monitor = $INTERNAL_MONITOR, preferred, auto, 1.5"
  fi

  # Write to config file so state persists across Hyprland config reloads
  echo "$conf" > "$MONITORS_CONF"
}

schedule_apply() {
  if [[ -n "$debounce_pid" ]] && kill -0 "$debounce_pid" 2>/dev/null; then
    kill "$debounce_pid" 2>/dev/null || true
  fi
  (sleep "$DEBOUNCE_SECS" && apply_monitors) &
  debounce_pid=$!
}

cleanup() {
  if [[ -n "$debounce_pid" ]] && kill -0 "$debounce_pid" 2>/dev/null; then
    kill "$debounce_pid" 2>/dev/null || true
  fi
  exit 0
}
trap cleanup EXIT INT TERM

apply_monitors

SOCKET="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"
while true; do
  socat -u "UNIX-CONNECT:$SOCKET" - | while IFS= read -r line; do
    case "$line" in
      monitoradded\>*|monitorremoved\>*)
        schedule_apply
        ;;
    esac
  done || true
  sleep 1
  apply_monitors
done