#+title: Core Settings
#+author: Vladimir Kosteley
#+description: Sane defaults, utilities, and core functionality
#+startup: showeverything

* Table of Contents :toc:
- [[#sane-defaults][Sane Defaults]]
  - [[#backup][Backup]]
  - [[#buffer-local-defaults][Buffer-local defaults]]
  - [[#completion][Completion]]
  - [[#ediff][Ediff]]
  - [[#editing][Editing]]
  - [[#environment][Environment]]
  - [[#files][Files]]
  - [[#minibuffer][Minibuffer]]
  - [[#misc][Misc]]
  - [[#performance][Performance]]
  - [[#scroll][Scroll]]
  - [[#ssh-agent][SSH Agent]]
  - [[#startup][Startup]]
  - [[#tab-bar][Tab Bar]]
  - [[#ui][UI]]
  - [[#window][Window]]
- [[#custom-functions][Custom Functions]]
  - [[#buffer][Buffer]]
  - [[#config][Config]]
  - [[#display][Display]]
  - [[#editing-1][Editing]]
  - [[#files-1][Files]]
  - [[#folding][Folding]]
  - [[#scroll-1][Scroll]]
- [[#editorconfig][Editorconfig]]
- [[#expand-region][Expand Region]]
- [[#kirigami][Kirigami]]
- [[#move-where-i-mean][Move Where I Mean]]
- [[#multiple-cursors][Multiple Cursors]]
- [[#sudo-edit][Sudo Edit]]
- [[#super-save][Super Save]]
- [[#track-changes][Track Changes]]
- [[#transient][Transient]]
- [[#trimming-whitespace][Trimming Whitespace]]

* Sane Defaults
** Backup
By default, Emacs creates automatic backups of files in their original directories, such "file.el" and the backup "file.el~".  This leads to a lot of clutter, so let's tell Emacs to put all backups that it creates in the =TRASH= directory.

#+begin_src emacs-lisp
(setq backup-directory-alist '((".*" . "~/.local/share/Trash/files")))
#+end_src

** Buffer-local defaults
#+begin_src emacs-lisp
(setq-default cursor-type '(bar . 2)
              fill-column 90
              indent-tabs-mode nil
              line-spacing 0.12)
#+end_src

** Completion
#+begin_src emacs-lisp
(setq completion-cycle-threshold nil
      read-extended-command-predicate #'command-completion-default-include-p
      tab-always-indent t
      text-mode-ispell-word-completion nil)
#+end_src

** Ediff
#+begin_src emacs-lisp
(setq ediff-split-window-function 'split-window-horizontally)
(setq ediff-window-setup-function 'ediff-setup-windows-plain)
#+end_src

** Editing
#+begin_src emacs-lisp
(delete-selection-mode 1)
(electric-pair-mode 1)
#+end_src

** Environment
https://github.com/purcell/envrc

#+begin_src emacs-lisp
(use-package envrc
  :ensure t
  :init
  (envrc-global-mode))
#+end_src

** Files
#+begin_src emacs-lisp
(global-auto-revert-mode t)
(save-place-mode 1)
(savehist-mode 1)

(setq delete-by-moving-to-trash t
      save-place-file (concat user-emacs-directory ".emacs-places"))
#+end_src

*** Persistent Scratch
https://github.com/Fanael/persistent-scratch

#+begin_src emacs-lisp
(use-package persistent-scratch
  :ensure t
  :config
  (persistent-scratch-setup-default))
#+end_src

** Minibuffer
By default, Emacs requires you to hit ESC three times to escape quit the minibuffer.
#+begin_src emacs-lisp
(global-set-key [escape] 'keyboard-escape-quit)
#+end_src

Enable recursive minibuffers.
#+begin_src emacs-lisp
(setq enable-recursive-minibuffers t)
#+end_src

Disable scroll bar in minibuffer.
#+begin_src emacs-lisp
(add-hook 'minibuffer-setup-hook
          #'(lambda () (set-window-scroll-bars (selected-window) 0 nil)))
#+end_src

** Misc
#+begin_src emacs-lisp
(setq calendar-week-start-day 1
      use-short-answers t)
#+end_src

** Performance
#+begin_src emacs-lisp
(setq gc-cons-threshold (* 100 1024 1024)
      read-process-output-max (* 1024 1024))

(setq jit-lock-chunk-size 4000
      jit-lock-stealth-nice 0.1
      jit-lock-stealth-time 1)
#+end_src

** Scroll
#+begin_src emacs-lisp
(pixel-scroll-precision-mode 1)

(setq auto-window-vscroll nil
      pixel-scroll-precision-interpolate-page t
      pixel-scroll-precision-large-scroll-height 40.0
      recenter-positions '(0.18 top bottom)
      scroll-conservatively 0
      scroll-margin 0
      scroll-preserve-screen-position t
      scroll-step 0)
#+end_src

** SSH Agent
#+begin_src emacs-lisp
(setenv "SSH_AUTH_SOCK" "/run/user/1000/ssh-agent.socket")
#+end_src

** Startup
#+begin_src emacs-lisp
(setq inhibit-startup-screen t
      initial-major-mode 'text-mode
      initial-scratch-message nil)
#+end_src

** Tab Bar
#+begin_src emacs-lisp
(tab-bar-mode -1)

(setq tab-bar-auto-width nil
      tab-bar-close-button-show nil
      tab-bar-format '(tab-bar-format-history tab-bar-format-tabs-groups tab-bar-separator tab-bar-format-add-tab)
      tab-bar-new-button-show nil
      tab-bar-new-tab-choice "*scratch*"
      tab-bar-new-tab-to 'rightmost
      tab-bar-tab-hints t)
#+end_src

** UI
#+begin_src emacs-lisp
(fringe-mode 0)
(menu-bar-mode -1)
(scroll-bar-mode -1)
(tool-bar-mode -1)

;; Custom line continuation/truncation indicators
(unless standard-display-table
  (setq standard-display-table (make-display-table)))
(set-display-table-slot standard-display-table 'truncation ?…)
(set-display-table-slot standard-display-table 'wrap ?↩)

(add-hook 'text-mode-hook #'visual-line-mode)
(add-hook 'text-mode-hook #'visual-wrap-prefix-mode)

(setq-default truncate-lines t)

(setq ring-bell-function #'ignore
      vc-display-status nil
      visual-line-fringe-indicators '(left-curly-arrow right-curly-arrow)
      warning-minimum-level :error)
#+end_src

** Window
#+begin_src emacs-lisp
(require 'buffer-move)
#+end_src

* Custom Functions
** Buffer
#+begin_src emacs-lisp
(defun ismd/reload-buffer ()
  "Reload the current buffer from disk without confirmation."
  (interactive)
  (revert-buffer nil t))

(defvar-local ismd/temporary-buffer-p nil
  "Non-nil if this buffer is a temporary buffer that should be closed when switching away.")

(defun ismd/find-file-temporarily (filename)
  "Open a file temporarily. The buffer will be automatically closed when switching to another buffer."
  (interactive "FFind file temporarily: ")
  (let ((buffer (find-file-noselect filename)))
    (with-current-buffer buffer
      (setq-local ismd/temporary-buffer-p t)
      (setq-local buffer-read-only t))
    (switch-to-buffer buffer)))

(defvar ismd/temporary-buffer-cleanup-in-progress nil
  "Guard variable to prevent infinite recursion during cleanup.")

(defun ismd/temporary-buffer-cleanup ()
  "Clean up temporary buffers when switching away from them."
  (unless ismd/temporary-buffer-cleanup-in-progress
    (let ((ismd/temporary-buffer-cleanup-in-progress t)
          (prev-buffer (other-buffer (current-buffer) t)))
      (when (and prev-buffer
                 (buffer-live-p prev-buffer)
                 (buffer-local-value 'ismd/temporary-buffer-p prev-buffer))
        (kill-buffer prev-buffer)))))

(add-hook 'buffer-list-update-hook #'ismd/temporary-buffer-cleanup)
#+end_src

** Config
#+begin_src emacs-lisp
(defun ismd/open-emacs-config ()
  "Open Emacs config.org file."
  (interactive)
  (find-file "~/.config/emacs/config.org"))

(defun ismd/open-emacs-directory ()
  "Open Emacs configuration directory in dired."
  (interactive)
  (dired "~/.config/emacs"))
#+end_src

** Display
#+begin_src emacs-lisp
(defun ismd/disable-line-numbers ()
  "Disable line numbers in current buffer."
  (display-line-numbers-mode -1))

(defun ismd/add-display-buffer-rule (buffer-name &optional window-width)
  "Add a display-buffer rule for BUFFER-NAME with optional WINDOW-WIDTH (default 0.35)."
  (let ((width (or window-width 0.35)))
    (add-to-list 'display-buffer-alist
                 `(,buffer-name
                   (display-buffer-in-side-window)
                   (side . right)
                   (window-width . ,width)
                   (window-parameters . ((no-delete-other-windows . t)))))))
#+end_src

** Editing
#+begin_src emacs-lisp
(defun ismd/delete-word (arg)
  "Delete characters forward until encountering the end of a word.
With argument ARG, do this that many times."
  (interactive "p")
  (delete-region (point) (progn (forward-word arg) (point))))

(defun ismd/delete-word-backward (arg)
  "Delete characters backward until encountering the end of a word.
With argument ARG, do this that many times."
  (interactive "p")
  (ismd/delete-word (- arg)))

(defun ismd/delete-line ()
  "Delete text from current position to end of line char.
If at end of line, delete the following newline char."
  (interactive)
  (let ((end (line-end-position)))
    (when (eolp)
      (delete-char 1))
    (delete-region (point) end)))
#+end_src

** Files
#+begin_src emacs-lisp
(defun ismd/delete-this-file ()
  "Delete the file associated with the current buffer and kill the buffer with confirmation."
  (interactive)
  (let ((filename (buffer-file-name)))
    (if filename
        (if (y-or-n-p (format "Are you sure you want to delete %s? " filename))
            (progn
              (delete-file filename)
              (message "Deleted file %s" filename)
              (kill-current-buffer))
          (message "Canceled"))
      (message "Not a file"))))
#+end_src

** Folding
#+begin_src emacs-lisp
(defun ismd/is-treesit-mode-p ()
  "Check if current major mode is a tree-sitter mode."
  (string-suffix-p "-ts-mode" (symbol-name major-mode)))

(defun ismd/fold-toggle ()
  "Toggle fold using treesit-fold for tree-sitter modes, kirigami otherwise."
  (interactive)
  (if (ismd/is-treesit-mode-p)
      (treesit-fold-toggle)
    (kirigami-toggle-fold)))

(defun ismd/fold-close-all ()
  "Close all folds using treesit-fold for tree-sitter modes, kirigami otherwise."
  (interactive)
  (if (ismd/is-treesit-mode-p)
      (treesit-fold-close-all)
    (kirigami-close-folds)))

(defun ismd/fold-open-all ()
  "Open all folds using treesit-fold for tree-sitter modes, kirigami otherwise."
  (interactive)
  (if (ismd/is-treesit-mode-p)
      (treesit-fold-open-all)
    (kirigami-open-folds)))
#+end_src

** Scroll
#+begin_src emacs-lisp
(defun ismd/scroll-down-lines ()
  "Scroll down 3 lines."
  (interactive)
  (scroll-up-command 3))

(defun ismd/scroll-up-lines ()
  "Scroll up 3 lines."
  (interactive)
  (scroll-down-command 3))
#+end_src

* Editorconfig
https://github.com/editorconfig/editorconfig-emacs

#+begin_src emacs-lisp
(use-package editorconfig
  :ensure t
  :config
  (editorconfig-mode 1))
#+end_src

* Expand Region
https://github.com/magnars/expand-region.el

#+begin_src emacs-lisp
(use-package expand-region
  :ensure t)
#+end_src

* Kirigami
https://github.com/jamescherti/kirigami.el

#+begin_src emacs-lisp
(use-package kirigami
  :ensure t)
#+end_src

* Move Where I Mean
https://github.com/alezost/mwim.el

#+begin_src emacs-lisp
(use-package mwim
  :ensure t
  :config
  (setq mwim-beginning-of-line-function 'beginning-of-line
        mwim-end-of-line-function 'end-of-line))
#+end_src

* Multiple Cursors
https://github.com/magnars/multiple-cursors.el

#+begin_src emacs-lisp
(use-package multiple-cursors
  :ensure t)
#+end_src

* Sudo Edit
[[https://github.com/nflath/sudo-edit][sudo-edit]] gives us the ability to open files with sudo privileges or switch over to editing with sudo privileges if we initially opened the file without such privileges.

#+begin_src emacs-lisp
(use-package sudo-edit
  :ensure t)
#+end_src

* Super Save
https://github.com/bbatsov/super-save

#+begin_src emacs-lisp
(use-package super-save
  :ensure t
  :config
  (super-save-mode +1)

  (setq auto-save-default nil
        super-save-auto-save-when-idle t
        super-save-silent t))
#+end_src

* Track Changes
#+begin_src emacs-lisp
(use-package track-changes
  :ensure t)
#+end_src

* Transient
https://github.com/magit/transient

Transient is the library used to implement the keyboard-driven "menus" in Magit and other packages.

#+begin_src emacs-lisp
(use-package transient
  :ensure t)
#+end_src

* Trimming Whitespace
#+begin_src emacs-lisp
(use-package ws-butler
  :ensure t
  :config
  (ws-butler-global-mode 1)
  (setq ws-butler-global-exempt-modes '(dockerfile-ts-mode markdown-mode terraform-mode)))
#+end_src
